USE daugiadb;

CREATE TABLE nguoidungs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    hoTen VARCHAR(100) NOT NULL,
    soDienThoai VARCHAR(20) NOT NULL,
    diaChi TEXT NOT NULL,
    vaiTro ENUM('ROLE_ADMIN', 'ROLE_NGUOIBAN', 'ROLE_NGUOIMUA') DEFAULT 'ROLE_NGUOIMUA',
    avatar VARCHAR(255),
    ngayTao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    trangThai VARCHAR(20)
);

-- Bang loai san pham
CREATE TABLE loaisanpham (
    id INT AUTO_INCREMENT PRIMARY KEY,
    tenLoai VARCHAR(50) NOT NULL
);

-- Bang san pham
CREATE TABLE sanphams (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nguoiDung_id INT,
    loaiSanPham_id INT,
    tenSanPham VARCHAR(100) NOT NULL,
    moTa TEXT NOT NULL,
    hinhAnh VARCHAR(255) NOT NULL,
    giaKhoiDiem DECIMAL(10,2) NOT NULL,
    buocNhay DECIMAL(10,2) NOT NULL,
    giaBua DECIMAL(10,2),
    ngayDang TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    trangThai ENUM('CHO_DUYET', 'DUYET', 'KHONG_DUYET') DEFAULT 'CHO_DUYET',
    FOREIGN KEY (nguoiDung_id) REFERENCES nguoidungs(id),
    FOREIGN KEY (loaiSanPham_id) REFERENCES loaisanpham(id)
);

-- Bang phien dau gia
CREATE TABLE phiendaugia (
    id INT AUTO_INCREMENT PRIMARY KEY,
    sanPham_id INT,
    thoiGianBatDau DATETIME,
    thoiGianKetThuc DATETIME,
    trangThai ENUM('dang_dien_ra', 'da_ket_thuc', 'huy') DEFAULT 'dang_dien_ra',
    giaChot DECIMAL(10,2),
    nguoiThangDauGia_id INT,
    FOREIGN KEY (sanPham_id) REFERENCES sanphams(id),
    FOREIGN KEY (nguoiThangDauGia_id) REFERENCES nguoidungs(id)
);

-- Bảng luot dau gia
CREATE TABLE phiendaugia_nguoidung (
    id INT AUTO_INCREMENT PRIMARY KEY,
    phienDauGia_id INT,
    nguoiDung_id INT,
    giaDau DECIMAL(10,2),
    thoiGianDauGia TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (phienDauGia_id) REFERENCES phiendaugia(id),
    FOREIGN KEY (nguoiDung_id) REFERENCES nguoidungs(id)
);

-- Bang danh sach theo doi san pham
CREATE TABLE theodoisanpham (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nguoiDung_id INT,
    sanPham_id INT,
    ngayTheoDoi TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (nguoiDung_id) REFERENCES nguoidungs(id) ON DELETE CASCADE,
    FOREIGN KEY (sanPham_id) REFERENCES sanphams(id) ON DELETE CASCADE,
    UNIQUE (nguoiDung_id, sanPham_id)
);

USE daugiadb;
UPDATE nguoidungs SET vaiTro = 'ROLE_ADMIN' WHERE username = 'admin';
INSERT INTO nguoidungs (username, password, email, hoTen, soDienThoai, diaChi, vaiTro, trangThai)
VALUES (
    'admin',
    '$2a$10$Af7DHT4moV4hfhQk.Y7DFu6ACjD5mgzXPMgs3Bjf0qKUqtx41yOhO',
    'admin@gmail.com',
    'Quản Trị Viên',
    '0123456789',
    'TP.HCM',
    'ROLE_ADMIN',
    'DUOC_DUYET'
);
